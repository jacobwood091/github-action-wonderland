name: Azure Board Reference Check

on:
    pull_request:
        types: [opened, edited, ready_for_review, reopened]

jobs:
    check-for-azure-board-item:
        runs-on: ubuntu-latest
        permissions:
            checks: write
            pull-requests: write
            contents: read
        steps:
            - name: Check for Azure Board Reference
              uses: actions/github-script@v7
              with:
                  script: |
                      const checkName = 'Azure Board Reference Check / check-for-azure-board-item';

                      // Skip validation for draft PRs
                      if (context.payload.pull_request.draft) {
                        return;
                      }

                      const description = context.payload.pull_request.body || '';

                      // Check for AB number
                      const abRegex = /AB#\d+/;
                      const hasABNumber = abRegex.test(description);

                      // Check for "no-ab" override in description
                      const hasOverride = /\bno-ab\b/i.test(description);

                      let conclusion, checkTitle, summary;

                      if (hasABNumber) {
                        conclusion = 'success';
                        checkTitle = '✅ Azure Board item found';
                        summary = 'Found Azure Board reference in PR description.';
                      } else if (hasOverride) {
                        conclusion = 'success';
                        checkTitle = '✅ Override applied (no-ab)';
                        summary = 'Azure Board check bypassed via "no-ab" in PR description.';
                      } else {
                        conclusion = 'failure';
                        checkTitle = '❌ Azure Board item required';
                        summary = `
                        No Azure Board item was found in the PR description.
                        
                        **Required Action:**
                        Please add an Azure Board reference in the format \`AB#<number>\` to your PR description.
                        
                        **Override Option:**
                        If the reference is not needed, add "no-ab" to your PR description to skip this check.
                        `;
                      }

                      // Create or update the check
                      await github.rest.checks.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        name: checkName,
                        head_sha: context.payload.pull_request.head.sha,
                        status: 'completed',
                        conclusion: conclusion,
                        output: {
                          title: checkTitle,
                          summary: summary
                        }
                      });
