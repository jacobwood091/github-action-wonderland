name: Azure Board Reference Check

on:
    pull_request:
        types: [opened, edited, ready_for_review, reopened]

jobs:
    check-for-azure-board-item:
        runs-on: ubuntu-latest
        permissions:
            checks: write
            statuses: write
            pull-requests: write
            contents: read
        steps:
            - name: Check for Azure Board Reference
              uses: actions/github-script@v7
              with:
                  script: |
                      // Skip validation for draft PRs
                      if (context.payload.pull_request.draft) {
                        console.log('â­ï¸ Skipping check for draft PR');
                        return;
                      }

                      const { owner, repo } = context.repo;
                      const pull_number = context.payload.pull_request.number;
                      const description = context.payload.pull_request.body || '';

                      // Check for AB number
                      const abRegex = /AB#\d+/;
                      const hasABNumber = abRegex.test(description);
                      const abMatch = description.match(abRegex);

                      // Check for "no-ab" override in description
                      const hasOverride = /\bno-ab\b/i.test(description);

                      // Create check run for better visibility
                      const checkName = 'Azure Board Reference';

                      try {
                        if (hasABNumber) {
                          // Success case
                          await github.rest.checks.create({
                            owner,
                            repo,
                            name: checkName,
                            head_sha: context.payload.pull_request.head.sha,
                            status: 'completed',
                            conclusion: 'success',
                            output: {
                              title: 'Azure Board reference found',
                              summary: `Found Azure Board reference: ${abMatch[0]}`,
                              text: 'This PR correctly references an Azure Board work item.'
                            }
                          });
                          
                          console.log('âœ… Azure Board item found:', abMatch[0]);
                          
                        } else if (hasOverride) {
                          // Override case
                          await github.rest.checks.create({
                            owner,
                            repo,
                            name: checkName,
                            head_sha: context.payload.pull_request.head.sha,
                            status: 'completed',
                            conclusion: 'success',
                            output: {
                              title: 'Azure Board check bypassed',
                              summary: 'Check bypassed using "no-ab" override',
                              text: 'The Azure Board reference requirement has been bypassed as requested.'
                            }
                          });
                          
                          console.log('âœ… Override applied (no-ab)');
                          
                        } else {
                        // Failure case - create detailed check and helpful PR comment
                        const checkText = [
                          '## Azure Board Reference Required',
                          '',
                          'This pull request requires an Azure Board work item reference.',
                          '',
                          '### To resolve:',
                          'â€¢ Add `AB#1234` to your PR description (replace with your work item number)',
                          'â€¢ Or add `no-ab` to bypass this requirement',
                          '',
                          '### Example:',
                          '```',
                          'Fixed login validation issue',
                          '',
                          'AB#1234',
                          '```'
                        ].join('\n');

                          await github.rest.checks.create({
                            owner,
                            repo,
                            name: checkName,
                            head_sha: context.payload.pull_request.head.sha,
                            status: 'completed',
                            conclusion: 'failure',
                            output: {
                              title: 'Azure Board reference required',
                              summary: 'No Azure Board work item reference found in PR description',
                              text: checkText
                            }
                          });

                        // Add a helpful comment to the PR
                        const commentBody = [
                          '## Azure Board Reference Required',
                          '',
                          'This pull request needs an Azure Board work item reference.',
                          '',
                          '**To resolve:** Add `AB#1234` to your PR description (replace with your work item number)',
                          '',
                          '**No work item needed?** Add `no-ab` to bypass this check',
                          '',
                          'This requirement helps maintain project traceability. Thanks! ðŸ™‚'
                        ].join('\n');

                        // Check if we already commented to avoid spam
                        const { data: comments } = await github.rest.issues.listComments({
                          owner,
                          repo,
                          issue_number: pull_number,
                        });

                        const botComment = comments.find(comment => 
                          comment.user.type === 'Bot' && 
                          comment.body.includes('Azure Board Reference Required')
                        );

                        if (!botComment) {
                          await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number: pull_number,
                            body: commentBody
                          });
                        }
                        
                          console.log('âŒ Azure Board item required - Check and comment created');
                          
                          // Set exit code to fail the workflow
                          process.exit(1);
                        }
                      } catch (error) {
                        console.log('âš ï¸ Checks API failed, falling back to status API');
                        console.log('Error:', error.message);
                        
                        // Fallback to Status API if Checks API fails
                        const sha = context.payload.pull_request.head.sha;
                        
                        if (hasABNumber) {
                          await github.rest.repos.createCommitStatus({
                            owner,
                            repo,
                            sha,
                            state: 'success',
                            description: `Azure Board reference found: ${abMatch[0]}`,
                            context: 'Azure Board Reference'
                          });
                        } else if (hasOverride) {
                          await github.rest.repos.createCommitStatus({
                            owner,
                            repo,
                            sha,
                            state: 'success',
                            description: 'Azure Board check bypassed using "no-ab" override',
                            context: 'Azure Board Reference'
                          });
                        } else {
                          await github.rest.repos.createCommitStatus({
                            owner,
                            repo,
                            sha,
                            state: 'failure',
                            description: 'Azure Board reference required. Add "AB#1234" or "no-ab" to PR description.',
                            context: 'Azure Board Reference'
                          });
                          
                          // Still add the PR comment for failure cases
                          const commentBody = [
                            '## Azure Board Reference Required',
                            '',
                            'This pull request needs an Azure Board work item reference.',
                            '',
                            '**To resolve:** Add `AB#1234` to your PR description (replace with your work item number)',
                            '',
                            '**No work item needed?** Add `no-ab` to bypass this check',
                            '',
                            'This requirement helps maintain project traceability. Thanks! ðŸ™‚'
                          ].join('\n');

                          const { data: comments } = await github.rest.issues.listComments({
                            owner,
                            repo,
                            issue_number: pull_number,
                          });

                          const botComment = comments.find(comment => 
                            comment.user.type === 'Bot' && 
                            comment.body.includes('Azure Board Reference Required')
                          );

                          if (!botComment) {
                            await github.rest.issues.createComment({
                              owner,
                              repo,
                              issue_number: pull_number,
                              body: commentBody
                            });
                          }
                          
                          process.exit(1);
                        }
                      }
